# Реестр Архитектурных Правил

Этот документ — единственный источник правды об архитектуре проекта и правилах организации файлов. Он предназначен для разработчиков и AI-ассистентов, чтобы обеспечить консистентность кодовой базы. Каждому правилу присвоен уникальный идентификатор (ID) для удобства ссылок.

## 1. Ключевые Принципы

- **[PRN-01] Feature-Sliced Design (FSD):** Проект построен на принципах FSD. Код группируется по бизнес-сущностям (доменам) и функциональным слоям, а не по техническому назначению.
- **[PRN-02] Явное разделение Client/Server:** Для предсказуемости и производительности мы строго разделяем серверный и клиентский код с помощью суффиксов файлов и директив Next.js.
- **[PRN-03] Public API для слоев:** Каждый слой (особенно домен) должен предоставлять четкий Public API через `index.ts` (для клиента) и `index.server.ts` (для сервера), скрывая детали реализации.

## 2. Структура Каталогов

**[STR-01]** Проект должен строго следовать приведенной ниже структуре каталогов. Любые отклонения должны быть согласованы и задокументированы.

```
/
├── app/                  # Слой страниц и роутинга Next.js
├── domains/              # Слой бизнес-доменов (ключевая логика)
│   └── <domain-name>/    # Изолированный модуль бизнес-логики
├── shared/               # Переиспользуемый код (UI-кит, утилиты, конфиги)
├── widgets/              # Композиционные блоки UI (комбинации фич и сущностей)
├── features/             # Фрагменты бизнес-логики (действия пользователя)
├── entities/             # Бизнес-сущности (например, User, Product)
├── public/               # Статические ассеты
├── scripts/              # Скрипты для сборки, деплоя и т.д.
└── memory-bank/          # Документация для AI
```

## 3. Правила по Слоям и Файлам

### Таблица 1: Правила для слоев верхнего уровня

| ID       | Слой (`/path`) | Назначение                      | Разрешенные импорты                                    | Запрещенные импорты                                 |
| -------- | -------------- | ------------------------------- | ------------------------------------------------------ | --------------------------------------------------- |
| **L-01** | `app/`         | Роутинг, страницы, макеты       | `domains`, `widgets`, `features`, `entities`, `shared` | -                                                   |
| **L-02** | `domains/`     | Изолированная бизнес-логика     | `shared`                                               | Другие `domains`, `app`, `widgets`                  |
| **L-03** | `widgets/`     | Сложные UI-компоненты           | `features`, `entities`, `shared`                       | `app`, другие `widgets`                             |
| **L-04** | `features/`    | Действия пользователя           | `entities`, `shared`                                   | `app`, `widgets`                                    |
| **L-05** | `entities/`    | Бизнес-сущности                 | `shared`                                               | `app`, `widgets`, `features`                        |
| **L-06** | `shared/`      | Фундаментальные утилиты, UI-кит | `node_modules`                                         | `app`, `domains`, `widgets`, `features`, `entities` |

### Таблица 2: Правила для внутренней структуры домена (`domains/<domain-name>/`)

| ID       | Путь                    | Назначение                      | Среда    | Ключевые правила                                                  |
| -------- | ----------------------- | ------------------------------- | -------- | ----------------------------------------------------------------- |
| **D-01** | `index.ts`              | Public API домена (client-safe) | `client` | Экспортирует только UI-компоненты, типы, константы.               |
| **D-02** | `index.server.ts`       | Public API домена (server-only) | `server` | Экспортирует `actions`, `queries`, серверные сервисы.             |
| **D-03** | `actions/*.server.ts`   | Server Actions                  | `server` | Файлы с директивой `"use server"`. Для мутаций данных.            |
| **D-04** | `data/*.repo.server.ts` | Репозитории (доступ к БД)       | `server` | Единственное место для прямых запросов к БД через ORM.            |
| **D-05** | `features/*.server.ts`  | Оркестраторы бизнес-логики      | `server` | Координируют работу `actions` и `data`. Пример: `crud.server.ts`. |
| **D-06** | `lib/`                  | Утилиты домена                  | `shared` | Чистые функции, специфичные для этого домена.                     |
| **D-07** | `model/`                | Модели данных, константы, enums | `shared` | Определения, используемые во всем домене.                         |
| **D-08** | `orm.server.ts`         | Drizzle ORM схема               | `server` | Определение таблиц и связей для домена.                           |
| **D-09** | `types.shared.ts`       | Zod-схемы и общие типы          | `shared` | Типы, безопасные для передачи между сервером и клиентом.          |
| **D-10** | `ui/*.client.tsx`       | React-компоненты                | `client` | UI-компоненты с директивой `"use client"`.                        |

### Таблица 3: Правила именования файлов и директив

| ID       | Суффикс / Директива | Среда    | Назначение                                                 | Запрещено                                                                  |
| -------- | ------------------- | -------- | ---------------------------------------------------------- | -------------------------------------------------------------------------- |
| **N-01** | `.server.ts(x)`     | `server` | Код, выполняемый только на сервере.                        | Использовать Browser API, `useState`, `useEffect`.                         |
| **N-02** | `// server-only`    | `server` | Гарантирует, что модуль не попадет в клиентский бандл.     | Импортировать в файлах без этой директивы, которые не являются серверными. |
| **N-03** | `"use server"`      | `server` | Помечает функции как Server Actions.                       | Использовать в файлах, не предназначенных для Server Actions.              |
| **N-04** | `.client.ts(x)`     | `client` | Код, выполняемый только в браузере.                        | Использовать Node.js API, прямой доступ к БД.                              |
| **N-05** | `"use client"`      | `client` | Помечает модуль как клиентский компонент.                  | Использовать в серверных файлах.                                           |
| **N-06** | `.shared.ts`        | `shared` | Код, безопасный для выполнения и на сервере, и на клиенте. | Импортировать `server-only` или `client-only` код.                         |
